// test/Ticket.test.js

// Load OpenZeppelin
const { deployProxy } = require("@openzeppelin/truffle-upgrades");
const { expectEvent, expectRevert } = require("@openzeppelin/test-helpers");

// Load dependencies
const { expect } = require("chai");

// Load compiled artifacts
const Organizer = artifacts.require("Organizer");
const Event = artifacts.require("Event");
const Ticket = artifacts.require("Ticket");

// Start test block
describe("Ticket", function () {
  beforeEach(async function () {
    this.Organizer = await deployProxy(Organizer, []);
    this.Event = await deployProxy(Event, [Organizer.address]);
    this.Ticket = await deployProxy(Ticket, [Event.address]);
    this.accounts = await web3.eth.getAccounts();
  });

  it("Create Ticket", async function () {
    const organizer_admin = this.accounts[0];
    const organizer_name = "Flavio";
    const organizer_description = "The best event organizer";

    let res = await this.Ticket.create_organizer(
      organizer_name,
      organizer_description
    );

    await expectEvent(res, "TicketCreated", {
      _admin: organizer_admin,
      _name: organizer_name,
      _description: organizer_description,
    });

    // check that the organizer is added to the organizer_list
    const organizer_list = await this.Ticket.organizer_list(0);
    assert.equal(organizer_list, organizer_admin);

    // check that the organizer is added to the organizers mapping
    const organizerStruct = await this.Ticket.organizers(organizer_admin);
    assert.equal(organizerStruct.name, organizer_name);
    assert.equal(organizerStruct.description, organizer_description);
    assert.equal(organizerStruct.is_set, true);
  });

  it("Check that user is an Ticket only after creating one", async function () {
    const organizer_name = "Flavio";
    const organizer_description = "The best event organizer";

    assert.isFalse(await this.Ticket.is_organizer(this.accounts[0]));

    await this.Ticket.create_organizer(organizer_name, organizer_description);

    assert.isTrue(await this.Ticket.is_organizer(this.accounts[0]));
  });

  it("Cannot create multiple Tickets from same account", async function () {
    const organizer_name = "Flavio";
    const organizer_description = "The best event organizer";

    await this.Ticket.create_organizer(organizer_name, organizer_description);

    await expectRevert(
      this.Ticket.create_organizer(organizer_name, organizer_description),
      "Sender is already an organizer"
    );
  });

  it("Can create multiple Tickets", async function () {
    const organizer_name = "Flavio";
    const organizer_description = "The best event organizer";

    const organizer_name_2 = "Paolo";
    const organizer_description_2 = "The second best event organizer";

    await this.Ticket.create_organizer(organizer_name, organizer_description);

    await this.Ticket.create_organizer(
      organizer_name_2,
      organizer_description_2,
      { from: this.accounts[1] }
    );
  });
});
